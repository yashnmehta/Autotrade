#include "views/Preference.h"
#include "ui_Preference.h"
#include "utils/PreferencesManager.h"
#include <QFileDialog>
#include <QColorDialog>
#include <QMessageBox>
#include <QDialogButtonBox>
#include <QDir>
#include <QDebug>

PreferenceDialog::PreferenceDialog(QWidget *parent)
    : QDialog(parent)
    , ui(new Ui::PreferenceDialog)
    , m_prefsManager(&PreferencesManager::instance())
{
    ui->setupUi(this);
    
    // Set dialog properties
    setWindowTitle("Preferences");
    setModal(true);
    setFixedSize(620, 480);
    
    // Load current preferences
    loadPreferences();
    
    // Setup connections
    setupConnections();
    
    qDebug() << "[PreferenceDialog] Initialized";
}

PreferenceDialog::~PreferenceDialog()
{
    delete ui;
}

void PreferenceDialog::setupConnections()
{
    // Look for standard dialog buttons (OK, Apply, Cancel)
    // These might be in a QDialogButtonBox
    QDialogButtonBox *buttonBox = findChild<QDialogButtonBox*>();
    if (buttonBox) {
        connect(buttonBox, &QDialogButtonBox::accepted, this, &PreferenceDialog::onOkClicked);
        connect(buttonBox, &QDialogButtonBox::rejected, this, &QDialog::reject);
        
        // Check if there's an Apply button
        QPushButton *applyBtn = buttonBox->button(QDialogButtonBox::Apply);
        if (applyBtn) {
            connect(applyBtn, &QPushButton::clicked, this, &PreferenceDialog::onApplyClicked);
        }
    }
    
    qDebug() << "[PreferenceDialog] Connections setup complete";
}

void PreferenceDialog::loadPreferences()
{
    // Try to load preferences into UI elements if they exist
    // This is a safe implementation that checks for widget existence
    
    // Since we don't know the exact widget names in the UI file,
    // we'll implement a minimal version that works with the PreferencesManager
    
    qDebug() << "[PreferenceDialog] Loading preferences...";
    qDebug() << "  Order Type:" << m_prefsManager->getDefaultOrderType();
    qDebug() << "  Product:" << m_prefsManager->getDefaultProduct();
    qDebug() << "  Validity:" << m_prefsManager->getDefaultValidity();
    qDebug() << "  Auto Fill Price:" << m_prefsManager->getAutoFillPrice();
    
    // TODO: Map these to actual UI widgets once we know their names
}

void PreferenceDialog::savePreferences()
{
    // Save preferences from UI to PreferencesManager
    // For now, this is a stub that will be implemented when we know the widget names
    
    qDebug() << "[PreferenceDialog] Saving preferences...";
    
    // QSettings auto-saves, no explicit save() needed
    
    qDebug() << "[PreferenceDialog] Preferences saved";
}

void PreferenceDialog::applyPreferences()
{
    savePreferences();
    QMessageBox::information(this, "Preferences", "Preferences have been applied.");
}

void PreferenceDialog::onApplyClicked()
{
    applyPreferences();
}

void PreferenceDialog::onOkClicked()
{
    savePreferences();
    accept();
}

void PreferenceDialog::onRestoreDefaultsClicked()
{
    QMessageBox::StandardButton reply = QMessageBox::question(
        this,
        "Restore Defaults",
        "Are you sure you want to restore all preferences to default values?",
        QMessageBox::Yes | QMessageBox::No
    );
    
    if (reply == QMessageBox::Yes) {
        // Reset to defaults
        m_prefsManager->setDefaultOrderType("LIMIT");
        m_prefsManager->setDefaultProduct("INTRADAY");
        m_prefsManager->setDefaultValidity("DAY");
        m_prefsManager->setAutoFillPrice(true);
        m_prefsManager->setAutoCalculatePrice(true);
        m_prefsManager->setBuyPriceOffset(0.05);
        m_prefsManager->setSellPriceOffset(0.05);
        // QSettings auto-saves
        
        loadPreferences();
        QMessageBox::information(this, "Preferences", "Default preferences have been restored.");
    }
}

void PreferenceDialog::onBrowseClicked()
{
    QString currentDir = QDir::homePath(); // Default to home directory
    
    QString dir = QFileDialog::getExistingDirectory(
        this,
        "Select Masters Directory",
        currentDir,
        QFileDialog::ShowDirsOnly | QFileDialog::DontResolveSymlinks
    );
    
    if (!dir.isEmpty()) {
        // Store the path in window preferences
        m_prefsManager->setWindowPreference("general", "mastersPath", dir);
        qDebug() << "[PreferenceDialog] Masters path set to:" << dir;
    }
}

void PreferenceDialog::onColorButtonClicked()
{
    QPushButton *btn = qobject_cast<QPushButton*>(sender());
    if (!btn) return;
    
    QColor currentColor = btn->palette().button().color();
    QColor color = QColorDialog::getColor(currentColor, this, "Select Color");
    
    if (color.isValid()) {
        btn->setStyleSheet(QString("background-color: %1;").arg(color.name()));
        // TODO: Save color to preferences when color settings are added
    }
}

void PreferenceDialog::onMoveUpClicked()
{
    // TODO: Implement when column order management is added
}

void PreferenceDialog::onMoveDownClicked()
{
    // TODO: Implement when column order management is added
}
